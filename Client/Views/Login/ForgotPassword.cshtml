@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model Entity.ModelRequest.ForgotPasswordRequest

@{
    ViewData["Title"] = "Forgot Password";
    Layout = "_Layout";
}

<div class="container-fluid min-vh-100 d-flex align-items-center justify-content-center bg-light">
    <div class="row w-100 justify-content-center">
        <div class="col-12 col-sm-8 col-md-6 col-lg-4 col-xl-3">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-4 p-md-5">
                    <div class="text-center mb-4">
                        <div class="bg-warning bg-gradient rounded-circle d-inline-flex align-items-center justify-content-center mb-3 shadow-sm"
                            style="width: 80px; height: 80px;">
                            <i class="fas fa-key text-white fa-2x"></i>
                        </div>
                        <h4 class="fw-bold text-dark mb-2">Forgot Password?</h4>
                        <p class="text-muted mb-0">Enter your email to reset password</p>
                    </div>

                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            @TempData["ErrorMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            @TempData["SuccessMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <form id="forgotPasswordForm" asp-controller="Login" asp-action="ForgotPassword" method="post">
                        <div class="mb-4">
                            <label for="email" class="form-label fw-semibold text-dark">
                                <i class="fas fa-envelope text-warning me-2"></i>Email Address
                            </label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="fas fa-envelope text-muted"></i>
                                </span>
                                <input id="email" asp-for="Email" type="email" class="form-control border-start-0"
                                    placeholder="Enter your registered email address" />
                            </div>
                            <span asp-validation-for="Email" class="text-danger small"></span>
                            <span id="emailError" class="text-danger small"></span>
                        </div>

                        <div class="d-grid mb-3">
                            <button type="submit" id="submitBtn" class="btn btn-warning btn-lg fw-semibold shadow-sm">
                                <span id="submitText">
                                    <i class="fas fa-paper-plane me-2"></i>Send New Password
                                </span>
                                <span id="loadingText" class="d-none">
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    Sending...
                                </span>
                            </button>
                        </div>

                        <div class="text-center">
                            <span class="text-muted">Remember your password? </span>
                            <a asp-controller="Login" asp-action="Index" class="text-decoration-none text-primary fw-semibold">Back to Login</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('#forgotPasswordForm').on('submit', function(e) {
                e.preventDefault();
                
                const email = $('#email').val().trim();
                const submitBtn = $('#submitBtn');
                const submitText = $('#submitText');
                const loadingText = $('#loadingText');
                
                $('#emailError').text('');
                if (!email) {
                    $('#emailError').text('Email không được để trống');
                    return;
                }
                
                const emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
                if (!emailRegex.test(email)) {
                    $('#emailError').text('Email không hợp lệ');
                    return;
                }
                
                submitBtn.prop('disabled', true);
                submitText.addClass('d-none');
                loadingText.removeClass('d-none');
                $.ajax({
                    url: window.apiBaseUrl + '/account/forgotPassword',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ email: email }),
                    success: function(response) {
                        const successAlert = `
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fas fa-check-circle me-2"></i>
                                ${response.message || 'Mật khẩu mới đã được gửi đến email của bạn'}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;
                        $('.card-body').prepend(successAlert);
                        
                        $('#email').val('');
                        setTimeout(function() {
                            window.location.href = '@Url.Action("Index", "Login")';
                        }, 3000);
                    },
                    error: function(xhr) {
                        let errorMessage = 'Có lỗi xảy ra, vui lòng thử lại';
                        
                        if (xhr.status === 404) {
                            errorMessage = 'Email không tồn tại trong hệ thống';
                        } else if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        } else if (xhr.responseText) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                errorMessage = response.message || response.title || errorMessage;
                            } catch (e) {
                            }
                        }
                        
                        const errorAlert = `
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                ${errorMessage}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;
                        $('.card-body').prepend(errorAlert);
                    },
                    complete: function() {
                        submitBtn.prop('disabled', false);
                        submitText.removeClass('d-none');
                        loadingText.addClass('d-none');
                    }
                });
            });
        });
    </script>
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
